package main

import (
	"fmt"
	"os"
	"syscall"
)

var (
	lkp = map[byte]int{
		0x00: 0, 0x01: 1, 0x02: 1, 0x03: 2, 0x04: 1, 0x05: 2, 0x06: 2, 0x07: 3, 0x08: 1, 0x09: 2, 0x0A: 2, 0x0B: 3, 0x0C: 2, 0x0D: 3, 0x0E: 3, 0x0F: 4,
		0x10: 1, 0x11: 2, 0x12: 2, 0x13: 3, 0x14: 2, 0x15: 3, 0x16: 3, 0x17: 4, 0x18: 2, 0x19: 3, 0x1A: 3, 0x1B: 4, 0x1C: 3, 0x1D: 4, 0x1E: 4, 0x1F: 5,
		0x20: 1, 0x21: 2, 0x22: 2, 0x23: 3, 0x24: 2, 0x25: 3, 0x26: 3, 0x27: 4, 0x28: 2, 0x29: 3, 0x2A: 3, 0x2B: 4, 0x2C: 3, 0x2D: 4, 0x2E: 4, 0x2F: 5,
		0x30: 2, 0x31: 3, 0x32: 3, 0x33: 4, 0x34: 3, 0x35: 4, 0x36: 4, 0x37: 5, 0x38: 3, 0x39: 4, 0x3A: 4, 0x3B: 5, 0x3C: 4, 0x3D: 5, 0x3E: 5, 0x3F: 6,
		0x40: 1, 0x41: 2, 0x42: 2, 0x43: 3, 0x44: 2, 0x45: 3, 0x46: 3, 0x47: 4, 0x48: 2, 0x49: 3, 0x4A: 3, 0x4B: 4, 0x4C: 3, 0x4D: 4, 0x4E: 4, 0x4F: 5,
		0x50: 2, 0x51: 3, 0x52: 3, 0x53: 4, 0x54: 3, 0x55: 4, 0x56: 4, 0x57: 5, 0x58: 3, 0x59: 4, 0x5A: 4, 0x5B: 5, 0x5C: 4, 0x5D: 5, 0x5E: 5, 0x5F: 6,
		0x60: 2, 0x61: 3, 0x62: 3, 0x63: 4, 0x64: 3, 0x65: 4, 0x66: 4, 0x67: 5, 0x68: 3, 0x69: 4, 0x6A: 4, 0x6B: 5, 0x6C: 4, 0x6D: 5, 0x6E: 5, 0x6F: 6,
		0x70: 3, 0x71: 4, 0x72: 4, 0x73: 5, 0x74: 4, 0x75: 5, 0x76: 5, 0x77: 6, 0x78: 4, 0x79: 5, 0x7A: 5, 0x7B: 6, 0x7C: 5, 0x7D: 6, 0x7E: 6, 0x7F: 7,
		0x80: 1, 0x81: 2, 0x82: 2, 0x83: 3, 0x84: 2, 0x85: 3, 0x86: 3, 0x87: 4, 0x88: 2, 0x89: 3, 0x8A: 3, 0x8B: 4, 0x8C: 3, 0x8D: 4, 0x8E: 4, 0x8F: 5,
		0x90: 2, 0x91: 3, 0x92: 3, 0x93: 4, 0x94: 3, 0x95: 4, 0x96: 4, 0x97: 5, 0x98: 3, 0x99: 4, 0x9A: 4, 0x9B: 5, 0x9C: 4, 0x9D: 5, 0x9E: 5, 0x9F: 6,
		0xA0: 2, 0xA1: 3, 0xA2: 3, 0xA3: 4, 0xA4: 3, 0xA5: 4, 0xA6: 4, 0xA7: 5, 0xA8: 3, 0xA9: 4, 0xAA: 4, 0xAB: 5, 0xAC: 4, 0xAD: 5, 0xAE: 5, 0xAF: 6,
		0xB0: 3, 0xB1: 4, 0xB2: 4, 0xB3: 5, 0xB4: 4, 0xB5: 5, 0xB6: 5, 0xB7: 6, 0xB8: 4, 0xB9: 5, 0xBA: 5, 0xBB: 6, 0xBC: 5, 0xBD: 6, 0xBE: 6, 0xBF: 7,
		0xC0: 2, 0xC1: 3, 0xC2: 3, 0xC3: 4, 0xC4: 3, 0xC5: 4, 0xC6: 4, 0xC7: 5, 0xC8: 3, 0xC9: 4, 0xCA: 4, 0xCB: 5, 0xCC: 4, 0xCD: 5, 0xCE: 5, 0xCF: 6,
		0xD0: 3, 0xD1: 4, 0xD2: 4, 0xD3: 5, 0xD4: 4, 0xD5: 5, 0xD6: 5, 0xD7: 6, 0xD8: 4, 0xD9: 5, 0xDA: 5, 0xDB: 6, 0xDC: 5, 0xDD: 6, 0xDE: 6, 0xDF: 7,
		0xE0: 3, 0xE1: 4, 0xE2: 4, 0xE3: 5, 0xE4: 4, 0xE5: 5, 0xE6: 5, 0xE7: 6, 0xE8: 4, 0xE9: 5, 0xEA: 5, 0xEB: 6, 0xEC: 5, 0xED: 6, 0xEE: 6, 0xEF: 7,
		0xF0: 4, 0xF1: 5, 0xF2: 5, 0xF3: 6, 0xF4: 5, 0xF5: 6, 0xF6: 6, 0xF7: 7, 0xF8: 5, 0xF9: 6, 0xFA: 6, 0xFB: 7, 0xFC: 6, 0xFD: 7, 0xFE: 7, 0xFF: 8,
	}
)

func main() {
	var e error
	cmd := "count"
	args := len(os.Args)
	if args > 1 {
		cmd = os.Args[1]
	}
	switch cmd {
	case "print":
		e = print(getFile(), false, false)
	case "print_min":
		e = print(getFile(), false, true)
	case "count":
		e = print(getFile(), true, false)
	}
	if e != nil {
		fmt.Println(e)
	}
}

func print(file string, count, min bool) error {
	f, e := os.OpenFile(file, os.O_RDONLY, 0644)
	if e != nil {
		return e
	}
	defer f.Close()
	fi, e := f.Stat()
	if e != nil {
		return e
	}

	fd := int(f.Fd())

	mm, e := syscall.Mmap(fd, 0, int(fi.Size()), syscall.PROT_READ, syscall.MAP_SHARED)
	if e != nil {
		return e
	}
	defer syscall.Munmap(mm)

	b := mm[:fi.Size()]
	if count {
		sum := 0
		for i := 0; i < len(b); i++ {
			sum += lkp[b[i]]
		}
		fmt.Println(sum)
	} else {
		if min {
			printArrayMin(b)
		} else {
			printArray(b)
		}
	}
	return nil
}

func printArray(b []byte) {
	l := len(b)
	start := 5
	for i := 0; i < l; i++ {
		printByte(start, b[i])
		start += 24
	}
}

func printArrayMin(b []byte) {
	l := len(b)
	start := 5
	for i := 0; i < l; i++ {
		printByteMin(start, b[i])
		start += 24
	}
}

func printByte(s int, b byte) {
	k := 0
	for i := 7; i >= 0; i-- {
		if b&(1<<i) > 0 {
			fmt.Print(s, " ")
		}
		s += (2 + k)
		if k == 0 {
			k = 2
		} else {
			k = 0
		}
	}
	fmt.Println()
}

func printByteMin(s int, b byte) {
	if b == 0 {
		fmt.Println()
		return
	}
	k := 0
	fmt.Printf("%.2X ", b)
	for i := 7; i >= 0; i-- {
		if b&(1<<i) > 0 {
			fmt.Println(s)
			break
		}
		s += (2 + k)
		if k == 0 {
			k = 2
		} else {
			k = 0
		}
	}
}

func getFile() string {
	file := "bits"
	if len(os.Args) > 2 {
		if len(os.Args[2]) > 0 {
			file = os.Args[2]
		}
	}
	return file
}
